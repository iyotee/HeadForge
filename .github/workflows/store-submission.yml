name: Store Submission

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      store:
        description: 'Store to submit to (chrome, firefox, edge, all)'
        required: true
        type: choice
        options:
          - chrome
          - firefox
          - edge
          - all

jobs:
  prepare-packages:
    runs-on: ubuntu-latest
    outputs:
      chrome-zip: ${{ steps.prepare.outputs.chrome-zip }}
      firefox-zip: ${{ steps.prepare.outputs.firefox-zip }}
      edge-zip: ${{ steps.prepare.outputs.edge-zip }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build extension
      run: npm run build
      
    - name: Build store packages
      run: node scripts/build-stores.js
      
    - name: Prepare packages
      id: prepare
      run: |
        echo "chrome-zip=store/headforge-chrome.zip" >> $GITHUB_OUTPUT
        echo "firefox-zip=store/headforge-firefox.zip" >> $GITHUB_OUTPUT
        echo "edge-zip=store/headforge-edge.zip" >> $GITHUB_OUTPUT
        
    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: store-packages
        path: |
          store/headforge-chrome.zip
          store/headforge-firefox.zip
          store/headforge-edge.zip
        retention-days: 30

  submit-chrome:
    runs-on: ubuntu-latest
    needs: prepare-packages
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.store == 'chrome' || github.event.inputs.store == 'all'))
    
    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: store-packages
        path: store/
        
    - name: Submit to Chrome Web Store
      uses: samuelmeuli/action-chrome-extension@v1
      with:
        extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
        client-id: ${{ secrets.CHROME_CLIENT_ID }}
        client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
        refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
        zip-file: store/headforge-chrome.zip
        publish: true
        
    - name: Notify Chrome success
      if: success()
      run: echo "✅ Successfully submitted to Chrome Web Store"

  submit-firefox:
    runs-on: ubuntu-latest
    needs: prepare-packages
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.store == 'firefox' || github.event.inputs.store == 'all'))
    
    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: store-packages
        path: store/
        
    - name: Submit to Firefox Add-ons
      uses: add-ons/action@v1
      with:
        source: store/headforge-firefox.zip
        channel: listed
        api-key: ${{ secrets.FIREFOX_API_KEY }}
        api-secret: ${{ secrets.FIREFOX_API_SECRET }}
        
    - name: Notify Firefox success
      if: success()
      run: echo "✅ Successfully submitted to Firefox Add-ons"

  submit-edge:
    runs-on: ubuntu-latest
    needs: prepare-packages
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.store == 'edge' || github.event.inputs.store == 'all'))
    
    steps:
    - name: Download packages
      uses: actions/download-artifact@v4
      with:
        name: store-packages
        path: store/
        
    - name: Submit to Microsoft Edge Add-ons
      uses: microsoft/edge-extension-action@v1
      with:
        product-id: ${{ secrets.EDGE_PRODUCT_ID }}
        client-id: ${{ secrets.EDGE_CLIENT_ID }}
        client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
        access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
        zip-file: store/headforge-edge.zip
        
    - name: Notify Edge success
      if: success()
      run: echo "✅ Successfully submitted to Microsoft Edge Add-ons"