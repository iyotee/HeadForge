name: Store Submission

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      store:
        description: 'Store to submit to (chrome, firefox, edge, all)'
        required: true
        type: choice
        options:
          - chrome
          - firefox
          - edge
          - all
      version:
        description: 'Version to submit'
        required: true
        type: string
      release_notes:
        description: 'Release notes for this submission'
        required: true
        type: string

jobs:
  submit-to-stores:
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        store: ${{ github.event_name == 'release' && fromJSON('["chrome", "firefox", "edge"]') || fromJSON(format('["{0}"]', github.event.inputs.store)) }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build extension
      run: npm run build
      
    - name: Build store packages
      run: node scripts/build-stores.js
      
    - name: Download release assets
      if: github.event_name == 'release'
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.run_number }}
        path: store/
        
    - name: Submit to Chrome Web Store
      if: matrix.store == 'chrome'
      uses: samuelmeuli/action-chrome-extension@v1
      with:
        extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
        client-id: ${{ secrets.CHROME_CLIENT_ID }}
        client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
        refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
        zip-file: store/headforge-chrome.zip
        publish: true
        
    - name: Submit to Firefox Add-ons
      if: matrix.store == 'firefox'
      uses: add-ons/action@v1
      with:
        source: store/headforge-firefox.zip
        channel: listed
        api-key: ${{ secrets.FIREFOX_API_KEY }}
        api-secret: ${{ secrets.FIREFOX_API_SECRET }}
        
    - name: Submit to Microsoft Edge Add-ons
      if: matrix.store == 'edge'
      uses: microsoft/edge-extension-action@v1
      with:
        product-id: ${{ secrets.EDGE_PRODUCT_ID }}
        client-id: ${{ secrets.EDGE_CLIENT_ID }}
        client-secret: ${{ secrets.EDGE_CLIENT_SECRET }}
        access-token-url: ${{ secrets.EDGE_ACCESS_TOKEN_URL }}
        zip-file: store/headforge-edge.zip
        
    - name: Notify submission success
      if: success()
      run: |
        echo "‚úÖ Successfully submitted to ${{ matrix.store }} store"
        echo "üîó Users will receive automatic updates through their browser"
        
    - name: Notify submission failure
      if: failure()
      run: |
        echo "‚ùå Failed to submit to ${{ matrix.store }} store"
        echo "üìã Check the logs for details"